<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Gest√£o de L√≠deres e Votos</title>
<style>
  body{font-family:Arial,Segoe UI,Tahoma,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;padding:24px}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.25);overflow:hidden}
  .header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:28px;text-align:center}
  .controls,.stats,.table-wrap{padding:24px}
  .controls{display:grid;grid-template-columns:1fr 1fr 200px auto;gap:12px;background:#f7f8fb}
  .controls label{font-weight:600;color:#333}
  .controls input{width:100%;padding:10px;border:2px solid #e6e6f0;border-radius:10px}
  .btn{border:0;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer;transition:all 0.2s}
  .btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
  .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  .btn-secondary{background:#6c757d;color:#fff}
  .btn-danger{background:#dc3545;color:#fff}
  .btn-success{background:#28a745;color:#fff}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;background:#f7f8fb}
  .card{background:#fff;border-radius:12px;padding:18px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  .card h4{margin:0 0 8px;color:#666;text-transform:uppercase;font-size:.85rem;letter-spacing:.04em}
  .card .num{font-size:2rem;font-weight:800;color:#5b6cee}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  thead{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  th,td{padding:14px;border-bottom:1px solid #f0f0f5;text-align:left}
  .actions{display:flex;gap:8px}
  .searchbar{display:flex;gap:12px;align-items:center;margin:0 24px 24px;flex-wrap:wrap}
  .searchbar input, .searchbar select{padding:10px;border:2px solid #e6e6f0;border-radius:24px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10}
  .modal .box{background:#fff;padding:24px;border-radius:14px;max-width:420px;width:90%}
  .modal .box .row{margin-bottom:12px}
  .modal .box .row label{display:block;margin-bottom:4px;font-weight:600}
  .modal .box .row input{width:100%;padding:10px;border:2px solid #e6e6f0;border-radius:8px;box-sizing:border-box}
  .share-section{background:#d4edda;padding:16px;margin:16px 24px;border-radius:8px;border-left:4px solid #28a745}
  .share-section h3{margin:0 0 8px;color:#155724}
  .share-section p{margin:4px 0;font-size:0.9em;color:#495057}
  .url-box{background:#fff;padding:8px 12px;border-radius:4px;border:1px solid #ced4da;word-break:break-all;font-family:monospace;font-size:0.9em}
  .alert{padding:12px;margin:16px 24px;border-radius:8px}
  .alert-success{background:#d4edda;border:1px solid #c3e6cb;color:#155724}
  .alert-warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
  .alert-error{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
  .connection-status{background:#17a2b8;padding:8px 16px;margin:16px 24px;border-radius:8px;color:#fff;text-align:center;font-weight:600}
  .connection-status.offline{background:#dc3545}
  .connection-status.online{background:#28a745}
  .sortable{cursor:pointer;user-select:none}
  .sortable:hover{background:rgba(255,255,255,0.1)}
  .firebase-info{background:#e3f2fd;padding:16px;margin:16px 24px;border-radius:8px;border-left:4px solid #2196f3}
  .firebase-info h3{margin:0 0 8px;color:#0d47a1}
  .loading{display:none;text-align:center;padding:20px;color:#666}
  .loading.show{display:block}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Sistema de Gest√£o de L√≠deres e Votos</h1>
      <p>Sistema Compartilhado em Tempo Real - Powered by Firebase üî•</p>
    </div>

    <div class="connection-status" id="connectionStatus">
      üîÑ Conectando ao Firebase...
    </div>

    <div class="firebase-info">
      <h3>üî• Sistema Compartilhado Ativo</h3>
      <p><strong>‚úÖ Dados sincronizados em tempo real:</strong> Todas as altera√ß√µes aparecem instantaneamente para todos os usu√°rios</p>
      <p><strong>üîó Compartilh√°vel:</strong> Envie este link para qualquer pessoa usar o sistema</p>
      <div class="url-box" id="shareUrl">Carregando URL...</div>
    </div>

    <div class="controls">
      <div>
        <label for="liderNome">Nome do L√≠der</label>
        <input id="liderNome" type="text" placeholder="Ex.: Ana Paula" disabled>
      </div>
      <div>
        <label for="cidade">Cidade</label>
        <input id="cidade" type="text" placeholder="Ex.: S√£o Jos√© do Rio Preto" disabled>
      </div>
      <div>
        <label for="votos">N√∫mero de Votos</label>
        <input id="votos" type="number" min="0" value="0" disabled>
      </div>
      <div style="display:flex;gap:8px;align-items:flex-end">
        <button id="btnAdicionar" class="btn btn-primary" disabled>‚ûï Adicionar L√≠der</button>
        <button id="btnLimpar" class="btn btn-secondary">üîÑ Limpar</button>
      </div>
    </div>

    <div class="stats">
      <div class="card"><h4>Total de L√≠deres</h4><div class="num" id="totalLideres">-</div></div>
      <div class="card"><h4>Total de Votos</h4><div class="num" id="totalVotos">-</div></div>
      <div class="card"><h4>Cidades Cadastradas</h4><div class="num" id="totalCidades">-</div></div>
      <div class="card"><h4>M√©dia de Votos</h4><div class="num" id="mediaVotos">-</div></div>
    </div>

    <div class="searchbar">
      <input id="searchInput" type="text" placeholder="üîé Buscar por l√≠der ou cidade...">
      <select id="filterCity">
        <option value="">Todas as cidades</option>
      </select>
      <button id="btnExportar" class="btn btn-success">üìÅ Exportar JSON</button>
    </div>

    <div class="loading" id="loadingIndicator">
      <h3>üîÑ Carregando dados...</h3>
      <p>Conectando ao Firebase e sincronizando informa√ß√µes</p>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-coluna="id">ID ‚Üï</th>
            <th class="sortable" data-coluna="nome">L√≠der ‚Üï</th>
            <th class="sortable" data-coluna="cidade">Cidade ‚Üï</th>
            <th class="sortable" data-coluna="votos">Votos ‚Üï</th>
            <th class="sortable" data-coluna="data">Data de Cadastro ‚Üï</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaCorpo"></tbody>
      </table>
      <div id="emptyState" style="text-align:center;padding:32px;color:#888;display:none">
        <h3>üìù Nenhum l√≠der cadastrado ainda</h3>
        <p>Comece adicionando seu primeiro l√≠der usando o formul√°rio acima</p>
        <p><small>üí° Os dados s√£o compartilhados em tempo real com todos os usu√°rios</small></p>
      </div>
    </div>
  </div>

  <!-- Modal de edi√ß√£o -->
  <div id="editModal" class="modal" onclick="if(event.target===this) fecharModal()">
    <div class="box">
      <h2>‚úèÔ∏è Editar L√≠der</h2>
      <div class="row">
        <label>Nome</label>
        <input id="editNome" type="text" placeholder="Nome do l√≠der">
      </div>
      <div class="row">
        <label>Cidade</label>
        <input id="editCidade" type="text" placeholder="Cidade">
      </div>
      <div class="row">
        <label>Votos</label>
        <input id="editVotos" type="number" min="0" placeholder="N√∫mero de votos">
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="salvarEdicao()">üíæ Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o -->
  <div id="confirmModal" class="modal">
    <div class="box">
      <h3 id="confirmTitle">Confirmar a√ß√£o</h3>
      <p id="confirmMessage">Tem certeza?</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-secondary" onclick="fecharConfirmacao(false)">Cancelar</button>
        <button class="btn btn-danger" onclick="fecharConfirmacao(true)">Confirmar</button>
      </div>
    </div>
  </div>

<!-- Firebase SDKs -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    doc, 
    updateDoc, 
    deleteDoc, 
    onSnapshot,
    orderBy,
    query 
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCaWmpEAfLH_x4lqGiHmOCjTgAnlf-VabQ",
    authDomain: "sistema-gestao-lideres.firebaseapp.com",
    projectId: "sistema-gestao-lideres",
    storageBucket: "sistema-gestao-lideres.firebasestorage.app",
    messagingSenderId: "831576985310",
    appId: "1:831576985310:web:7be43afa4d69a9d0d6fc4f"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Estado da aplica√ß√£o
  let lideres = [];
  let editandoId = null;
  let ordemAtual = { coluna: null, crescente: true };
  let confirmCallback = null;
  let unsubscribe = null;

  // Cole√ß√£o do Firestore
  const lideresCollection = collection(db, 'lideres');

  // --------- Inicializa√ß√£o ---------
  document.addEventListener('DOMContentLoaded', () => {
    configurarEventos();
    mostrarUrlCompartilhamento();
    conectarFirebase();
  });

  // --------- Conex√£o Firebase ---------
  function conectarFirebase() {
    mostrarCarregando(true);
    atualizarStatusConexao('Conectando ao Firebase...');
    
    try {
      // Configurar listener em tempo real
      const q = query(lideresCollection, orderBy('timestamp', 'desc'));
      
      unsubscribe = onSnapshot(q, (snapshot) => {
        lideres = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          lideres.push({
            id: doc.id,
            nome: data.nome,
            cidade: data.cidade,
            votos: data.votos || 0,
            data: data.data || formatarData(new Date()),
            timestamp: data.timestamp
          });
        });
        
        renderizarTabela();
        habilitarInterface();
        mostrarCarregando(false);
        atualizarStatusConexao('üü¢ Conectado - Dados sincronizados em tempo real', 'online');
      }, (error) => {
        console.error('Erro ao escutar mudan√ßas:', error);
        atualizarStatusConexao('üî¥ Erro de conex√£o', 'offline');
        mostrarMensagem('‚ùå Erro ao conectar com Firebase: ' + error.message, 'error');
        mostrarCarregando(false);
      });
      
    } catch (error) {
      console.error('Erro ao conectar Firebase:', error);
      atualizarStatusConexao('üî¥ Falha na conex√£o', 'offline');
      mostrarMensagem('‚ùå Erro ao inicializar Firebase: ' + error.message, 'error');
      mostrarCarregando(false);
    }
  }

  function atualizarStatusConexao(mensagem, status = '') {
    const elemento = document.getElementById('connectionStatus');
    elemento.textContent = mensagem;
    elemento.className = `connection-status ${status}`;
  }

  function habilitarInterface() {
    document.getElementById('liderNome').disabled = false;
    document.getElementById('cidade').disabled = false;
    document.getElementById('votos').disabled = false;
    document.getElementById('btnAdicionar').disabled = false;
  }

  function mostrarCarregando(show) {
    const loading = document.getElementById('loadingIndicator');
    if (show) {
      loading.classList.add('show');
    } else {
      loading.classList.remove('show');
    }
  }

  // --------- Event Listeners ---------
  function configurarEventos() {
    document.getElementById('btnAdicionar').addEventListener('click', adicionarLider);
    document.getElementById('btnLimpar').addEventListener('click', limparFormulario);
    document.getElementById('btnExportar').addEventListener('click', exportarDados);
    
    // Enter nos campos
    ['liderNome', 'cidade', 'votos'].forEach(id => {
      document.getElementById(id).addEventListener('keypress', (e) => {
        if (e.key === 'Enter') adicionarLider();
      });
    });

    // Busca e filtros
    document.getElementById('searchInput').addEventListener('input', filtrarTabela);
    document.getElementById('filterCity').addEventListener('change', filtrarTabela);

    // Ordena√ß√£o
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => ordenarTabela(th.dataset.coluna));
    });
  }

  // --------- CRUD Operations ---------
  async function adicionarLider() {
    const nome = document.getElementById('liderNome').value.trim();
    const cidade = document.getElementById('cidade').value.trim();
    const votos = parseInt(document.getElementById('votos').value) || 0;

    if (!validarCampos(nome, cidade)) return;

    try {
      const novoLider = {
        nome: nome,
        cidade: cidade,
        votos: votos,
        data: formatarData(new Date()),
        timestamp: new Date()
      };

      await addDoc(lideresCollection, novoLider);
      limparFormulario();
      mostrarMensagem(`‚úÖ L√≠der "${nome}" adicionado com sucesso!`, 'success');
      
    } catch (error) {
      console.error('Erro ao adicionar l√≠der:', error);
      mostrarMensagem('‚ùå Erro ao adicionar l√≠der: ' + error.message, 'error');
    }
  }

  async function editarLider(id) {
    const lider = lideres.find(l => l.id === id);
    if (!lider) return;

    editandoId = id;
    document.getElementById('editNome').value = lider.nome;
    document.getElementById('editCidade').value = lider.cidade;
    document.getElementById('editVotos').value = lider.votos || 0;
    document.getElementById('editModal').style.display = 'flex';
    
    setTimeout(() => document.getElementById('editNome').focus(), 100);
  }

  async function salvarEdicao() {
    const nome = document.getElementById('editNome').value.trim();
    const cidade = document.getElementById('editCidade').value.trim();
    const votos = parseInt(document.getElementById('editVotos').value) || 0;

    if (!validarCampos(nome, cidade)) return;

    try {
      const liderRef = doc(db, 'lideres', editandoId);
      await updateDoc(liderRef, {
        nome: nome,
        cidade: cidade,
        votos: votos,
        timestamp: new Date()
      });

      fecharModal();
      mostrarMensagem(`‚úÖ L√≠der "${nome}" atualizado com sucesso!`, 'success');
      
    } catch (error) {
      console.error('Erro ao atualizar l√≠der:', error);
      mostrarMensagem('‚ùå Erro ao atualizar l√≠der: ' + error.message, 'error');
    }
  }

  async function deletarLider(id) {
    const lider = lideres.find(l => l.id === id);
    if (!lider) return;

    confirmarAcao(
      'Excluir L√≠der',
      `Tem certeza que deseja excluir "${lider.nome}" de ${lider.cidade}?`,
      async () => {
        try {
          await deleteDoc(doc(db, 'lideres', id));
          mostrarMensagem(`‚úÖ L√≠der "${lider.nome}" exclu√≠do com sucesso!`, 'success');
        } catch (error) {
          console.error('Erro ao excluir l√≠der:', error);
          mostrarMensagem('‚ùå Erro ao excluir l√≠der: ' + error.message, 'error');
        }
      }
    );
  }

  // --------- Valida√ß√£o ---------
  function validarCampos(nome, cidade) {
    if (!nome) {
      mostrarMensagem('‚ùå Por favor, informe o nome do l√≠der', 'warning');
      document.getElementById('liderNome').focus();
      return false;
    }

    if (!cidade) {
      mostrarMensagem('‚ùå Por favor, informe a cidade', 'warning');
      document.getElementById('cidade').focus();
      return false;
    }

    if (nome.length < 2) {
      mostrarMensagem('‚ùå Nome deve ter pelo menos 2 caracteres', 'warning');
      return false;
    }

    return true;
  }

  // --------- Renderiza√ß√£o ---------
  function renderizarTabela() {
    const tbody = document.getElementById('tabelaCorpo');
    const empty = document.getElementById('emptyState');
    const dados = obterDadosFiltrados();

    if (!dados.length) {
      tbody.innerHTML = '';
      empty.style.display = 'block';
    } else {
      empty.style.display = 'none';
      tbody.innerHTML = dados.map(l => `
        <tr>
          <td><strong>#${l.id.substring(0, 8)}</strong></td>
          <td><strong style="color:#333">${escapeHtml(l.nome)}</strong></td>
          <td><span style="color:#666">${escapeHtml(l.cidade)}</span></td>
          <td style="color:#5b6cee;font-weight:700;font-size:1.1em">${formatarNumero(l.votos||0)}</td>
          <td style="color:#666;font-size:0.9em">${l.data||'N/A'}</td>
          <td>
            <div class="actions">
              <button class="btn btn-secondary" onclick="editarLider('${l.id}')" title="Editar l√≠der">‚úèÔ∏è</button>
              <button class="btn btn-danger" onclick="deletarLider('${l.id}')" title="Excluir l√≠der">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    atualizarEstatisticas();
    atualizarFiltroCidades();
  }

  function atualizarEstatisticas() {
    const dados = obterDadosFiltrados();
    const total = dados.length;
    const votos = dados.reduce((soma, lider) => soma + (Number(lider.votos) || 0), 0);
    const cidades = new Set(dados.map(l => l.cidade)).size;
    const media = total ? Math.round(votos / total) : 0;

    document.getElementById('totalLideres').textContent = formatarNumero(total);
    document.getElementById('totalVotos').textContent = formatarNumero(votos);
    document.getElementById('totalCidades').textContent = formatarNumero(cidades);
    document.getElementById('mediaVotos').textContent = formatarNumero(media);
  }

  function atualizarFiltroCidades() {
    const select = document.getElementById('filterCity');
    const valorAtual = select.value;
    const cidades = [...new Set(lideres.map(l => l.cidade))].sort();
    
    select.innerHTML = '<option value="">Todas as cidades</option>';
    cidades.forEach(cidade => {
      const option = document.createElement('option');
      option.value = cidade;
      option.textContent = cidade;
      select.appendChild(option);
    });
    
    select.value = valorAtual;
  }

  // --------- Filtros e Ordena√ß√£o ---------
  function obterDadosFiltrados() {
    const busca = (document.getElementById('searchInput')?.value || '').toLowerCase();
    const cidadeFiltro = (document.getElementById('filterCity')?.value || '').toLowerCase();
    
    return lideres.filter(lider => {
      const correspondeNome = !busca || lider.nome.toLowerCase().includes(busca);
      const correspondeCidade = !busca || lider.cidade.toLowerCase().includes(busca);
      const correspondeFiltroCidade = !cidadeFiltro || lider.cidade.toLowerCase() === cidadeFiltro;
      
      return (correspondeNome || correspondeCidade) && correspondeFiltroCidade;
    });
  }

  function filtrarTabela() {
    renderizarTabela();
  }

  function ordenarTabela(coluna) {
    if (ordemAtual.coluna === coluna) {
      ordemAtual.crescente = !ordemAtual.crescente;
    } else {
      ordemAtual.coluna = coluna;
      ordemAtual.crescente = true;
    }

    lideres.sort((a, b) => {
      let valorA = a[coluna];
      let valorB = b[coluna];

      if (coluna === 'nome' || coluna === 'cidade') {
        valorA = (valorA || '').toLowerCase();
        valorB = (valorB || '').toLowerCase();
      } else if (coluna === 'votos') {
        valorA = Number(valorA) || 0;
        valorB = Number(valorB) || 0;
      } else if (coluna === 'data') {
        valorA = new Date(valorA?.split('/').reverse().join('-') || '1970-01-01');
        valorB = new Date(valorB?.split('/').reverse().join('-') || '1970-01-01');
      }

      let resultado = 0;
      if (valorA < valorB) resultado = -1;
      else if (valorA > valorB) resultado = 1;

      return ordemAtual.crescente ? resultado : -resultado;
    });

    renderizarTabela();
  }

  // --------- Utility Functions ---------
  function limparFormulario() {
    document.getElementById('liderNome').value = '';
    document.getElementById('cidade').value = '';
    document.getElementById('votos').value = '0';
    document.getElementById('liderNome').focus();
  }

  function fecharModal() {
    document.getElementById('editModal').style.display = 'none';
    editandoId = null;
  }

  function formatarData(data) {
    return data.toLocaleDateString('pt-BR');
  }

  function formatarNumero(num) {
    return new Intl.NumberFormat('pt-BR').format(num);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function mostrarUrlCompartilhamento() {
    document.getElementById('shareUrl').textContent = window.location.href;
  }

  function mostrarMensagem(texto, tipo = 'success') {
    const existente = document.querySelector('.alert');
    if (existente) existente.remove();

    const div = document.createElement('div');
    div.className = `alert alert-${tipo}`;
    div.textContent = texto;
    
    const container = document.querySelector('.container');
    container.insertBefore(div, container.children[2]);
    
    setTimeout(() => {
      if (div.parentNode) div.remove();
    }, 5000);
  }

  function confirmarAcao(titulo, mensagem, callback) {
    document.getElementById('confirmTitle').textContent = titulo;
    document.getElementById('confirmMessage').textContent = mensagem;
    document.getElementById('confirmModal').style.display = 'flex';
    confirmCallback = callback;
  }

  function fecharConfirmacao(confirmar) {
    document.getElementById('confirmModal').style.display = 'none';
    if (confirmar && confirmCallback) {
      confirmCallback();
    }
    confirmCallback = null;
  }

  // --------- Export ---------
  function exportarDados() {
    try {
      const dados = {
        versao: '3.0-Firebase',
        exportadoEm: new Date().toISOString(),
        totalRegistros: lideres.length,
        lideres: lideres.map(l => ({
          nome: l.nome,
          cidade: l.cidade,
          votos: l.votos,
          data: l.data
        }))
      };

      const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `lideres_votos_firebase_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      mostrarMensagem('‚úÖ Dados exportados com sucesso!', 'success');
    } catch (error) {
      console.error('Erro ao exportar:', error);
      mostrarMensagem('‚ùå Erro ao exportar dados', 'error');
    }
  }

  // --------- Cleanup ---------
  window.addEventListener('beforeunload', () => {
    if (unsubscribe) {
      unsubscribe();
    }
  });

  // Expor fun√ß√µes globalmente para uso nos event handlers inline
  window.editarLider = editarLider;
  window.deletarLider = deletarLider;
  window.salvarEdicao = salvarEdicao;
  window.fecharModal = fecharModal;
  window.fecharConfirmacao = fecharConfirmacao;

  console.log('üî• Sistema Firebase inicializado com sucesso!');
</script>
</body>
</html>
    
    
